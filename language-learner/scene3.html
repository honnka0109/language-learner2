<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>ì–¸ì–´ í•™ìŠµê¸° - Scene 1</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #5d4037;
            position: relative;
        }

        /* ë°°ê²½ ì¥ì‹ */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.05)"/><circle cx="40" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
            pointer-events: none;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            padding: 30px 25px;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 10px 20px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .scene-header {
            margin-bottom: 25px;
        }

        .scene-title {
            font-size: 28px;
            font-weight: 700;
            color: #d84315;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(216, 67, 21, 0.1);
        }

        .scene-subtitle {
            font-size: 16px;
            color: #8d6e63;
            opacity: 0.8;
        }

        .audio-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 245, 238, 0.7);
            border-radius: 18px;
            border: 2px solid rgba(255, 193, 158, 0.3);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #bf360c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .button-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 16px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 140px;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            
            /* iOS í„°ì¹˜ ìµœì í™” */
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:active::before {
            left: 100%;
        }

        .play-btn {
            background: linear-gradient(135deg, #ff7043, #ff5722);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
        }

        .play-btn:hover, .play-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4);
        }

        .play-btn:disabled {
            background: #ffccbc;
            color: #8d6e63;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        .record-btn {
            background: linear-gradient(135deg, #e91e63, #c2185b);
            color: white;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        .record-btn:hover, .record-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(244, 67, 54, 0.5);
            }
        }

        .stop-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
            min-width: 120px;
        }

        .stop-btn:hover, .stop-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .replay-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .replay-btn:hover, .replay-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-container {
            margin: 20px 0;
            padding: 18px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 2px solid rgba(255, 193, 158, 0.2);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status {
            font-size: 15px;
            line-height: 1.4;
            color: #5d4037;
            font-weight: 500;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 12px;
            border: 2px solid rgba(244, 67, 54, 0.2);
            margin: 15px 0;
        }

        .recording-indicator.active {
            display: flex;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { 
                background: rgba(244, 67, 54, 0.1);
                border-color: rgba(244, 67, 54, 0.2);
            }
            50% { 
                background: rgba(244, 67, 54, 0.2);
                border-color: rgba(244, 67, 54, 0.4);
            }
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #f44336;
            border-radius: 50%;
            margin-right: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .recording-text {
            color: #f44336;
            font-weight: 600;
            font-size: 15px;
        }

        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #ffccbc, transparent);
            margin: 25px 0;
        }

        .auto-play-notice {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #388e3c;
            line-height: 1.4;
        }

        .saved-recording-notice {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            color: #1976d2;
            line-height: 1.4;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 480px) {
            .container {
                padding: 25px 20px;
                margin: 10px;
            }

            .scene-title {
                font-size: 24px;
            }

            button {
                min-width: 120px;
                padding: 14px 20px;
                font-size: 15px;
            }

            .button-row {
                flex-direction: column;
                align-items: center;
            }

            .stop-btn {
                min-width: 120px;
            }
        }

        @media (max-width: 360px) {
            .container {
                padding: 20px 15px;
            }

            button {
                min-width: 100px;
                padding: 12px 18px;
                font-size: 14px;
            }
        }

        /* iOS Safari íŠ¹ë³„ ì²˜ë¦¬ */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            button {
                -webkit-appearance: none;
                -webkit-user-select: none;
            }
        }

        /* PWA ìŠ¤íƒ€ì¼ */
        @media (display-mode: standalone) {
            body {
                padding-top: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scene-header">
            <div class="scene-title" id="sceneTitle">ğŸ­ Scene 1</div>
            <div class="scene-subtitle">ì–¸ì–´ í•™ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
        </div>
        
        <div class="audio-section">
            <div class="section-title">
                ğŸ§ <span>ì„±ìš° ìŒì„±</span>
            </div>
            <div class="button-group">
                <div class="button-row">
                    <button id="playOriginalBtn" class="play-btn">â–¶ï¸ ì¬ìƒí•˜ê¸°</button>
                    <button id="replayBtn" class="replay-btn">ğŸ”„ ë‹¤ì‹œ ë“£ê¸°</button>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="audio-section">
            <div class="section-title">
                ğŸ¤ <span>ë‚´ ëª©ì†Œë¦¬ ë…¹ìŒ</span>
            </div>
            <div class="button-group">
                <div class="button-row">
                    <button id="recordBtn" class="record-btn">ğŸ”´ ë…¹ìŒ ì‹œì‘</button>
                    <button id="stopRecordBtn" class="stop-btn" disabled>â¹ï¸ ì •ì§€</button>
                </div>
            </div>
            
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span class="recording-text">ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="audio-section">
            <div class="section-title">
                ğŸ”Š <span>ë‚´ ëª©ì†Œë¦¬ ë“£ê¸°</span>
            </div>
            <div class="button-group">
                <div class="button-row">
                    <button id="playRecordingBtn" class="replay-btn" disabled>â–¶ï¸ ë‚´ ëª©ì†Œë¦¬ ë“£ê¸°</button>
                </div>
            </div>
        </div>

        <div class="status-container">
            <div class="status" id="status">
                í™”ë©´ì„ í„°ì¹˜í•˜ë©´ í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
            </div>
        </div>

        <div class="auto-play-notice" id="autoPlayNotice" style="display: none;">
            ğŸ’¡ iOSì—ì„œëŠ” ì‚¬ìš©ìê°€ í„°ì¹˜í•œ í›„ì— ìŒì„±ì´ ì¬ìƒë©ë‹ˆë‹¤.
        </div>

        <div class="saved-recording-notice" id="savedRecordingNotice" style="display: none;">
            ğŸ’¾ ì´ì „ ë…¹ìŒì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤.
        </div>
    </div>

    <script>
        class LanguageLearningApp {
            constructor() {
                // í˜„ì¬ í˜ì´ì§€ì˜ scene ë²ˆí˜¸ ìë™ ê°ì§€
                this.sceneId = this.getCurrentSceneId();
                this.audioFileName = `audio/scene${this.sceneId}.m4a`;
                this.storageKey = `scene${this.sceneId}_recording`;
                
                this.originalAudio = null;
                this.recordedAudio = null;
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.isRecording = false;
                this.hasUserInteracted = false;
                this.savedRecordingExists = false;
                
                this.initElements();
                this.initAudio();
                this.bindEvents();
                this.checkSavedRecording();
                this.setupAutoPlayDetection();
                this.updateSceneTitle();
            }

            getCurrentSceneId() {
                // URLì—ì„œ scene ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: scene1.html -> 1)
                const path = window.location.pathname;
                const match = path.match(/scene(\d+)/i);
                return match ? match[1] : '1'; // ê¸°ë³¸ê°’ì€ 1
            }

            updateSceneTitle() {
                const titleElement = document.getElementById('sceneTitle');
                titleElement.textContent = `ğŸ­ Scene ${this.sceneId}`;
                document.title = `ì–¸ì–´ í•™ìŠµê¸° - Scene ${this.sceneId}`;
            }

            initElements() {
                this.playOriginalBtn = document.getElementById('playOriginalBtn');
                this.replayBtn = document.getElementById('replayBtn');
                this.recordBtn = document.getElementById('recordBtn');
                this.stopRecordBtn = document.getElementById('stopRecordBtn');
                this.playRecordingBtn = document.getElementById('playRecordingBtn');
                this.status = document.getElementById('status');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                this.autoPlayNotice = document.getElementById('autoPlayNotice');
                this.savedRecordingNotice = document.getElementById('savedRecordingNotice');
            }

            initAudio() {
                this.originalAudio = new Audio(this.audioFileName);
                this.originalAudio.preload = 'auto';
                
                // iOSì—ì„œ ì˜¤ë””ì˜¤ ë¡œë“œ ìµœì í™”
                this.originalAudio.load();
                
                this.originalAudio.addEventListener('loadeddata', () => {
                    this.updateStatus(`ğŸµ Scene ${this.sceneId} ìŒì„±ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                });
                
                this.originalAudio.addEventListener('error', (e) => {
                    console.error('Audio load error:', e);
                    this.updateStatus(`âš ï¸ ${this.audioFileName} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                });

                this.originalAudio.addEventListener('ended', () => {
                    this.updateStatus('ğŸ‰ ì„±ìš° ìŒì„± ì¬ìƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                });

                this.originalAudio.addEventListener('canplaythrough', () => {
                    console.log('Audio can play through');
                });
            }

            bindEvents() {
                this.playOriginalBtn.addEventListener('click', () => this.playOriginal());
                this.replayBtn.addEventListener('click', () => this.playOriginal());
                this.recordBtn.addEventListener('click', () => this.startRecording());
                this.stopRecordBtn.addEventListener('click', () => this.stopRecording());
                this.playRecordingBtn.addEventListener('click', () => this.playRecording());

                // iOS í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
                document.addEventListener('touchstart', () => {}, { passive: true });
                
                // ì²« ë²ˆì§¸ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ê°ì§€
                const markUserInteraction = () => {
                    if (!this.hasUserInteracted) {
                        this.hasUserInteracted = true;
                        this.onFirstUserInteraction();
                    }
                };

                ['click', 'touchstart', 'touchend'].forEach(event => {
                    document.addEventListener(event, markUserInteraction, { once: true, passive: true });
                });
            }

            setupAutoPlayDetection() {
                // iOS ê°ì§€
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                
                if (isIOS) {
                    this.autoPlayNotice.style.display = 'block';
                }
            }

            onFirstUserInteraction() {
                console.log('First user interaction detected');
                
                // ì €ì¥ëœ ë…¹ìŒì´ ìˆìœ¼ë©´ ìë™ ì¬ìƒ
                if (this.savedRecordingExists) {
                    setTimeout(() => {
                        this.playRecording();
                    }, 1000);
                } else {
                    // ì €ì¥ëœ ë…¹ìŒì´ ì—†ìœ¼ë©´ ì„±ìš° ìŒì„± ìë™ ì¬ìƒ
                    setTimeout(() => {
                        this.playOriginal();
                    }, 500);
                }
                
                this.autoPlayNotice.style.display = 'none';
            }

            async playOriginal() {
                try {
                    if (!this.originalAudio) {
                        this.updateStatus('âŒ ì˜¤ë””ì˜¤ íŒŒì¼ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ì´ì „ ì¬ìƒ ì¤‘ì§€
                    this.stopAllAudio();
                    
                    this.originalAudio.currentTime = 0;
                    
                    // iOSì—ì„œ play() promise ì²˜ë¦¬
                    const playPromise = this.originalAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        this.updateStatus('ğŸ”Š ì„±ìš° ìŒì„±ì„ ì¬ìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                    }
                    
                } catch (error) {
                    console.error('Play error:', error);
                    if (error.name === 'NotAllowedError') {
                        this.updateStatus('ğŸ”’ ë¸Œë¼ìš°ì €ì—ì„œ ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                    } else {
                        this.updateStatus('âŒ ìŒì„± ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            }

            async startRecording() {
                try {
                    // ë‹¤ë¥¸ ì˜¤ë””ì˜¤ ì •ì§€
                    this.stopAllAudio();
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    // iOS Safari í˜¸í™˜ MIME íƒ€ì… ì„¤ì •
                    const mimeTypes = [
                        'audio/mp4',
                        'audio/webm;codecs=opus',
                        'audio/ogg;codecs=opus',
                        'audio/wav'
                    ];
                    
                    let selectedMimeType = '';
                    for (const mimeType of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(mimeType)) {
                            selectedMimeType = mimeType;
                            console.log('Selected MIME type:', selectedMimeType);
                            break;
                        }
                    }
                    
                    if (!selectedMimeType) {
                        throw new Error('ì§€ì›ë˜ëŠ” ì˜¤ë””ì˜¤ í˜•ì‹ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    this.mediaRecorder = new MediaRecorder(stream, { 
                        mimeType: selectedMimeType,
                        audioBitsPerSecond: 128000
                    });
                    
                    this.recordedChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        this.processRecording();
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        this.updateStatus('âŒ ë…¹ìŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    };

                    this.mediaRecorder.start(100); // 100msë§ˆë‹¤ ë°ì´í„° ìˆ˜ì§‘
                    this.isRecording = true;
                    
                    // UI ì—…ë°ì´íŠ¸
                    this.recordBtn.disabled = true;
                    this.recordBtn.classList.add('recording');
                    this.stopRecordBtn.disabled = false;
                    this.recordingIndicator.classList.add('active');
                    this.updateStatus('ğŸ¤ ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤... ë˜ë ·í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”!');

                } catch (error) {
                    console.error('Recording start error:', error);
                    if (error.name === 'NotAllowedError') {
                        this.updateStatus('ğŸ”’ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    } else {
                        this.updateStatus(`âŒ ë…¹ìŒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
                    }
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    // UI ì—…ë°ì´íŠ¸
                    this.recordBtn.disabled = false;
                    this.recordBtn.classList.remove('recording');
                    this.stopRecordBtn.disabled = true;
                    this.recordingIndicator.classList.remove('active');
                    this.updateStatus('ğŸ“ ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ë¦¬ ì¤‘...');
                }
            }

            async processRecording() {
                try {
                    const blob = new Blob(this.recordedChunks, { 
                        type: this.recordedChunks[0]?.type || 'audio/webm'
                    });
                    
                    console.log('Recording blob size:', blob.size, 'type:', blob.type);
                    
                    if (blob.size === 0) {
                        throw new Error('ë…¹ìŒ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    }
                    
                    const audioUrl = URL.createObjectURL(blob);
                    
                    // ì´ì „ ì˜¤ë””ì˜¤ ì •ë¦¬
                    if (this.recordedAudio) {
                        URL.revokeObjectURL(this.recordedAudio.src);
                    }
                    
                    this.recordedAudio = new Audio(audioUrl);
                    this.playRecordingBtn.disabled = false;
                    
                    // localStorageì— ì €ì¥ (Base64ë¡œ ë³€í™˜)
                    await this.saveRecordingToStorage(blob);
                    
                    this.updateStatus('âœ… ë…¹ìŒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ìë™ìœ¼ë¡œ ì¬ìƒí•©ë‹ˆë‹¤...');
                    
                    // 1ì´ˆ í›„ ìë™ ì¬ìƒ
                    setTimeout(() => {
                        this.playRecording();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Processing recording error:', error);
                    this.updateStatus(`âŒ ë…¹ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }

            async saveRecordingToStorage(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            localStorage.setItem(this.storageKey, reader.result);
                            console.log('Recording saved to localStorage:', this.storageKey);
                            resolve();
                        } catch (error) {
                            console.error('localStorage save error:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('FileReader error'));
                    reader.readAsDataURL(blob);
                });
            }

            async playRecording() {
                try {
                    if (!this.recordedAudio) {
                        this.updateStatus('âŒ ì¬ìƒí•  ë…¹ìŒì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    this.stopAllAudio();
                    this.recordedAudio.currentTime = 0;
                    
                    const playPromise = this.recordedAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        this.updateStatus('ğŸ”Š ë‚´ ëª©ì†Œë¦¬ë¥¼ ì¬ìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                        
                        this.recordedAudio.onended = () => {
                            this.updateStatus('ğŸ‰ ë‚´ ëª©ì†Œë¦¬ ì¬ìƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        };
                    }
                    
                } catch (error) {
                    console.error('Recording playback error:', error);
                    this.updateStatus('âŒ ë…¹ìŒ ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            checkSavedRecording() {
                try {
                    const savedData = localStorage.getItem(this.storageKey);
                    if (savedData) {
                        console.log('Found saved recording for:', this.storageKey);
                        this.loadSavedRecording(savedData);
                        this.savedRecordingExists = true;
                        this.savedRecordingNotice.style.display = 'block';
                    } else {
                        console.log('No saved recording found for:', this.storageKey);
                    }
                } catch (error) {
                    console.error('Error checking saved recording:', error);
                }
            }

            async loadSavedRecording(base64Data) {
                try {
                    const response = await fetch(base64Data);
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    this.recordedAudio = new Audio(audioUrl);
                    this.playRecordingBtn.disabled = false;
                    
                    console.log('Saved recording loaded successfully');
                } catch (error) {
                    console.error('Error loading saved recording:', error);
                    // ì €ì¥ëœ ë°ì´í„°ê°€ ì†ìƒëœ ê²½ìš° ì œê±°
                    localStorage.removeItem(this.storageKey);
                    this.savedRecordingExists = false;
                    this.savedRecordingNotice.style.display = 'none';
                }
            }

            stopAllAudio() {
                // ì„±ìš° ìŒì„± ì •ì§€
                if (this.originalAudio) {
                    this.originalAudio.pause();
                    this.originalAudio.currentTime = 0;
                }
                
                // ë…¹ìŒ ìŒì„± ì •ì§€
                if (this.recordedAudio) {
                    this.recordedAudio.pause();
                    this.recordedAudio.currentTime = 0;
                }
            }

            updateStatus(message) {
                this.status.textContent = message;
                console.log('Status:', message);
            }

            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            cleanup() {
                this.stopAllAudio();
                
                if (this.recordedAudio) {
                    URL.revokeObjectURL(this.recordedAudio.src);
                }
                
                if (this.isRecording) {
                    this.stopRecording();
                }
            }
        }

        // ì•± ì´ˆê¸°í™”
        let app;
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = new LanguageLearningApp();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('App initialization error:', error);
                document.getElementById('status').textContent = 'ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (app) {
                app.cleanup();
            }
        });

        // iOS Safari ì¶”ê°€ ìµœì í™”
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) { 
                e.preventDefault(); 
            }
        }, { passive: false });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // í™”ë©´ íšŒì „ ì‹œ ë ˆì´ì•„ì›ƒ ì¡°ì •
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });

        // Service Worker ë“±ë¡ (PWA ì§€ì›)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed (normal in preview): ', registrationError);
                    });
            });
        }

        // Web App Manifest ì²´í¬
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running as PWA');
            document.body.style.paddingTop = '40px';
        }

        // ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ìœ„í•œ ì£¼ê¸°ì  ì •ë¦¬
        if (typeof setInterval !== 'undefined') {
            setInterval(() => {
                if (performance && performance.memory && performance.memory.usedJSHeapSize > 50000000) { // 50MB
                    console.log('Memory cleanup triggered');
                    if (window.gc) {
                        window.gc();
                    }
                }
            }, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
        }
    </script>
</body>
</html>