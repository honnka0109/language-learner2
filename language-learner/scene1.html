<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>언어 학습기 - Scene 1</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #5d4037;
            position: relative;
        }

        /* 배경 장식 */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.05)"/><circle cx="40" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
            pointer-events: none;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            padding: 30px 25px;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 10px 20px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .scene-header {
            margin-bottom: 25px;
        }

        .scene-title {
            font-size: 28px;
            font-weight: 700;
            color: #d84315;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(216, 67, 21, 0.1);
        }

        .scene-subtitle {
            font-size: 16px;
            color: #8d6e63;
            opacity: 0.8;
        }

        .audio-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 245, 238, 0.7);
            border-radius: 18px;
            border: 2px solid rgba(255, 193, 158, 0.3);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #bf360c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .button-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 16px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 140px;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            
            /* iOS 터치 최적화 */
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:active::before {
            left: 100%;
        }

        .play-btn {
            background: linear-gradient(135deg, #ff7043, #ff5722);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
        }

        .play-btn:hover, .play-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 87, 34, 0.4);
        }

        .play-btn:disabled {
            background: #ffccbc;
            color: #8d6e63;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        .record-btn {
            background: linear-gradient(135deg, #e91e63, #c2185b);
            color: white;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        }

        .record-btn:hover, .record-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(244, 67, 54, 0.5);
            }
        }

        .stop-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
            min-width: 120px;
        }

        .stop-btn:hover, .stop-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .replay-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .replay-btn:hover, .replay-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-container {
            margin: 20px 0;
            padding: 18px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 2px solid rgba(255, 193, 158, 0.2);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status {
            font-size: 15px;
            line-height: 1.4;
            color: #5d4037;
            font-weight: 500;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 12px;
            border: 2px solid rgba(244, 67, 54, 0.2);
            margin: 15px 0;
        }

        .recording-indicator.active {
            display: flex;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { 
                background: rgba(244, 67, 54, 0.1);
                border-color: rgba(244, 67, 54, 0.2);
            }
            50% { 
                background: rgba(244, 67, 54, 0.2);
                border-color: rgba(244, 67, 54, 0.4);
            }
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #f44336;
            border-radius: 50%;
            margin-right: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .recording-text {
            color: #f44336;
            font-weight: 600;
            font-size: 15px;
        }

        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #ffccbc, transparent);
            margin: 25px 0;
        }

        .auto-play-notice {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #388e3c;
            line-height: 1.4;
        }

        .saved-recording-notice {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid rgba(33, 150, 243, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            color: #1976d2;
            line-height: 1.4;
        }

        /* 모바일 최적화 */
        @media (max-width: 480px) {
            .container {
                padding: 25px 20px;
                margin: 10px;
            }

            .scene-title {
                font-size: 24px;
            }

            button {
                min-width: 120px;
                padding: 14px 20px;
                font-size: 15px;
            }

            .button-row {
                flex-direction: column;
                align-items: center;
            }

            .stop-btn {
                min-width: 120px;
            }
        }

        @media (max-width: 360px) {
            .container {
                padding: 20px 15px;
            }

            button {
                min-width: 100px;
                padding: 12px 18px;
                font-size: 14px;
            }
        }

        /* iOS Safari 특별 처리 */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            button {
                -webkit-appearance: none;
                -webkit-user-select: none;
            }
        }

        /* PWA 스타일 */
        @media (display-mode: standalone) {
            body {
                padding-top: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scene-header">
            <div class="scene-title" id="sceneTitle">🎭 Scene 1</div>
            <div class="scene-subtitle">언어 학습을 시작해보세요!</div>
        </div>
        
        <div class="audio-section">
            <div class="section-title">
                🎧 <span>성우 음성</span>
            </div>
            <div class="button-group">
                <div class="button-row">
                    <button id="playOriginalBtn" class="play-btn">▶️ 재생하기</button>
                    <button id="replayBtn" class="replay-btn">🔄 다시 듣기</button>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="audio-section">
            <div class="section-title">
                🎤 <span>내 목소리 녹음</span>
            </div>
            <div class="button-group">
                <div class="button-row">
                    <button id="recordBtn" class="record-btn">🔴 녹음 시작</button>
                    <button id="stopRecordBtn" class="stop-btn" disabled>⏹️ 정지</button>
                </div>
            </div>
            
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span class="recording-text">녹음 중입니다...</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="audio-section">
            <div class="section-title">
                🔊 <span>내 목소리 듣기</span>
            </div>
            <div class="button-group">
                <div class="button-row">
                    <button id="playRecordingBtn" class="replay-btn" disabled>▶️ 내 목소리 듣기</button>
                </div>
            </div>
        </div>

        <div class="status-container">
            <div class="status" id="status">
                화면을 터치하면 학습을 시작할 수 있습니다!
            </div>
        </div>

        <div class="auto-play-notice" id="autoPlayNotice" style="display: none;">
            💡 iOS에서는 사용자가 터치한 후에 음성이 재생됩니다.
        </div>

        <div class="saved-recording-notice" id="savedRecordingNotice" style="display: none;">
            💾 이전 녹음이 저장되어 있습니다. 자동으로 재생됩니다.
        </div>
    </div>

    <script>
        class LanguageLearningApp {
            constructor() {
                // 현재 페이지의 scene 번호 자동 감지
                this.sceneId = this.getCurrentSceneId();
                this.audioFileName = `audio/scene${this.sceneId}.m4a`;
                this.storageKey = `scene${this.sceneId}_recording`;
                
                this.originalAudio = null;
                this.recordedAudio = null;
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.isRecording = false;
                this.hasUserInteracted = false;
                this.savedRecordingExists = false;
                
                this.initElements();
                this.initAudio();
                this.bindEvents();
                this.checkSavedRecording();
                this.setupAutoPlayDetection();
                this.updateSceneTitle();
            }

            getCurrentSceneId() {
                // URL에서 scene 번호 추출 (예: scene1.html -> 1)
                const path = window.location.pathname;
                const match = path.match(/scene(\d+)/i);
                return match ? match[1] : '1'; // 기본값은 1
            }

            updateSceneTitle() {
                const titleElement = document.getElementById('sceneTitle');
                titleElement.textContent = `🎭 Scene ${this.sceneId}`;
                document.title = `언어 학습기 - Scene ${this.sceneId}`;
            }

            initElements() {
                this.playOriginalBtn = document.getElementById('playOriginalBtn');
                this.replayBtn = document.getElementById('replayBtn');
                this.recordBtn = document.getElementById('recordBtn');
                this.stopRecordBtn = document.getElementById('stopRecordBtn');
                this.playRecordingBtn = document.getElementById('playRecordingBtn');
                this.status = document.getElementById('status');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                this.autoPlayNotice = document.getElementById('autoPlayNotice');
                this.savedRecordingNotice = document.getElementById('savedRecordingNotice');
            }

            initAudio() {
                this.originalAudio = new Audio(this.audioFileName);
                this.originalAudio.preload = 'auto';
                
                // iOS에서 오디오 로드 최적화
                this.originalAudio.load();
                
                this.originalAudio.addEventListener('loadeddata', () => {
                    this.updateStatus(`🎵 Scene ${this.sceneId} 음성이 준비되었습니다!`);
                });
                
                this.originalAudio.addEventListener('error', (e) => {
                    console.error('Audio load error:', e);
                    this.updateStatus(`⚠️ ${this.audioFileName} 파일을 찾을 수 없습니다.`);
                });

                this.originalAudio.addEventListener('ended', () => {
                    this.updateStatus('🎉 성우 음성 재생이 완료되었습니다.');
                });

                this.originalAudio.addEventListener('canplaythrough', () => {
                    console.log('Audio can play through');
                });
            }

            bindEvents() {
                this.playOriginalBtn.addEventListener('click', () => this.playOriginal());
                this.replayBtn.addEventListener('click', () => this.playOriginal());
                this.recordBtn.addEventListener('click', () => this.startRecording());
                this.stopRecordBtn.addEventListener('click', () => this.stopRecording());
                this.playRecordingBtn.addEventListener('click', () => this.playRecording());

                // iOS 터치 이벤트 최적화
                document.addEventListener('touchstart', () => {}, { passive: true });
                
                // 첫 번째 사용자 상호작용 감지
                const markUserInteraction = () => {
                    if (!this.hasUserInteracted) {
                        this.hasUserInteracted = true;
                        this.onFirstUserInteraction();
                    }
                };

                ['click', 'touchstart', 'touchend'].forEach(event => {
                    document.addEventListener(event, markUserInteraction, { once: true, passive: true });
                });
            }

            setupAutoPlayDetection() {
                // iOS 감지
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                
                if (isIOS) {
                    this.autoPlayNotice.style.display = 'block';
                }
            }

            onFirstUserInteraction() {
                console.log('First user interaction detected');
                
                // 저장된 녹음이 있으면 자동 재생
                if (this.savedRecordingExists) {
                    setTimeout(() => {
                        this.playRecording();
                    }, 1000);
                } else {
                    // 저장된 녹음이 없으면 성우 음성 자동 재생
                    setTimeout(() => {
                        this.playOriginal();
                    }, 500);
                }
                
                this.autoPlayNotice.style.display = 'none';
            }

            async playOriginal() {
                try {
                    if (!this.originalAudio) {
                        this.updateStatus('❌ 오디오 파일이 준비되지 않았습니다.');
                        return;
                    }

                    // 이전 재생 중지
                    this.stopAllAudio();
                    
                    this.originalAudio.currentTime = 0;
                    
                    // iOS에서 play() promise 처리
                    const playPromise = this.originalAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        this.updateStatus('🔊 성우 음성을 재생하고 있습니다...');
                    }
                    
                } catch (error) {
                    console.error('Play error:', error);
                    if (error.name === 'NotAllowedError') {
                        this.updateStatus('🔒 브라우저에서 자동 재생이 차단되었습니다. 버튼을 다시 눌러주세요.');
                    } else {
                        this.updateStatus('❌ 음성 재생에 실패했습니다. 다시 시도해주세요.');
                    }
                }
            }

            async startRecording() {
                try {
                    // 다른 오디오 정지
                    this.stopAllAudio();
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    // iOS Safari 호환 MIME 타입 설정
                    const mimeTypes = [
                        'audio/mp4',
                        'audio/webm;codecs=opus',
                        'audio/ogg;codecs=opus',
                        'audio/wav'
                    ];
                    
                    let selectedMimeType = '';
                    for (const mimeType of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(mimeType)) {
                            selectedMimeType = mimeType;
                            console.log('Selected MIME type:', selectedMimeType);
                            break;
                        }
                    }
                    
                    if (!selectedMimeType) {
                        throw new Error('지원되는 오디오 형식이 없습니다.');
                    }

                    this.mediaRecorder = new MediaRecorder(stream, { 
                        mimeType: selectedMimeType,
                        audioBitsPerSecond: 128000
                    });
                    
                    this.recordedChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        this.processRecording();
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        this.updateStatus('❌ 녹음 중 오류가 발생했습니다.');
                    };

                    this.mediaRecorder.start(100); // 100ms마다 데이터 수집
                    this.isRecording = true;
                    
                    // UI 업데이트
                    this.recordBtn.disabled = true;
                    this.recordBtn.classList.add('recording');
                    this.stopRecordBtn.disabled = false;
                    this.recordingIndicator.classList.add('active');
                    this.updateStatus('🎤 녹음 중입니다... 또렷하게 말씀해주세요!');

                } catch (error) {
                    console.error('Recording start error:', error);
                    if (error.name === 'NotAllowedError') {
                        this.updateStatus('🔒 마이크 권한이 필요합니다. 브라우저 설정에서 권한을 허용해주세요.');
                    } else {
                        this.updateStatus(`❌ 녹음을 시작할 수 없습니다: ${error.message}`);
                    }
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    // UI 업데이트
                    this.recordBtn.disabled = false;
                    this.recordBtn.classList.remove('recording');
                    this.stopRecordBtn.disabled = true;
                    this.recordingIndicator.classList.remove('active');
                    this.updateStatus('📝 녹음이 완료되었습니다. 처리 중...');
                }
            }

            async processRecording() {
                try {
                    const blob = new Blob(this.recordedChunks, { 
                        type: this.recordedChunks[0]?.type || 'audio/webm'
                    });
                    
                    console.log('Recording blob size:', blob.size, 'type:', blob.type);
                    
                    if (blob.size === 0) {
                        throw new Error('녹음 데이터가 비어있습니다.');
                    }
                    
                    const audioUrl = URL.createObjectURL(blob);
                    
                    // 이전 오디오 정리
                    if (this.recordedAudio) {
                        URL.revokeObjectURL(this.recordedAudio.src);
                    }
                    
                    this.recordedAudio = new Audio(audioUrl);
                    this.playRecordingBtn.disabled = false;
                    
                    // localStorage에 저장 (Base64로 변환)
                    await this.saveRecordingToStorage(blob);
                    
                    this.updateStatus('✅ 녹음이 저장되었습니다! 자동으로 재생합니다...');
                    
                    // 1초 후 자동 재생
                    setTimeout(() => {
                        this.playRecording();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Processing recording error:', error);
                    this.updateStatus(`❌ 녹음 처리 중 오류가 발생했습니다: ${error.message}`);
                }
            }

            async saveRecordingToStorage(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            localStorage.setItem(this.storageKey, reader.result);
                            console.log('Recording saved to localStorage:', this.storageKey);
                            resolve();
                        } catch (error) {
                            console.error('localStorage save error:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('FileReader error'));
                    reader.readAsDataURL(blob);
                });
            }

            async playRecording() {
                try {
                    if (!this.recordedAudio) {
                        this.updateStatus('❌ 재생할 녹음이 없습니다.');
                        return;
                    }

                    this.stopAllAudio();
                    this.recordedAudio.currentTime = 0;
                    
                    const playPromise = this.recordedAudio.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        this.updateStatus('🔊 내 목소리를 재생하고 있습니다...');
                        
                        this.recordedAudio.onended = () => {
                            this.updateStatus('🎉 내 목소리 재생이 완료되었습니다!');
                        };
                    }
                    
                } catch (error) {
                    console.error('Recording playback error:', error);
                    this.updateStatus('❌ 녹음 재생에 실패했습니다.');
                }
            }

            checkSavedRecording() {
                try {
                    const savedData = localStorage.getItem(this.storageKey);
                    if (savedData) {
                        console.log('Found saved recording for:', this.storageKey);
                        this.loadSavedRecording(savedData);
                        this.savedRecordingExists = true;
                        this.savedRecordingNotice.style.display = 'block';
                    } else {
                        console.log('No saved recording found for:', this.storageKey);
                    }
                } catch (error) {
                    console.error('Error checking saved recording:', error);
                }
            }

            async loadSavedRecording(base64Data) {
                try {
                    const response = await fetch(base64Data);
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    this.recordedAudio = new Audio(audioUrl);
                    this.playRecordingBtn.disabled = false;
                    
                    console.log('Saved recording loaded successfully');
                } catch (error) {
                    console.error('Error loading saved recording:', error);
                    // 저장된 데이터가 손상된 경우 제거
                    localStorage.removeItem(this.storageKey);
                    this.savedRecordingExists = false;
                    this.savedRecordingNotice.style.display = 'none';
                }
            }

            stopAllAudio() {
                // 성우 음성 정지
                if (this.originalAudio) {
                    this.originalAudio.pause();
                    this.originalAudio.currentTime = 0;
                }
                
                // 녹음 음성 정지
                if (this.recordedAudio) {
                    this.recordedAudio.pause();
                    this.recordedAudio.currentTime = 0;
                }
            }

            updateStatus(message) {
                this.status.textContent = message;
                console.log('Status:', message);
            }

            // 페이지 언로드 시 리소스 정리
            cleanup() {
                this.stopAllAudio();
                
                if (this.recordedAudio) {
                    URL.revokeObjectURL(this.recordedAudio.src);
                }
                
                if (this.isRecording) {
                    this.stopRecording();
                }
            }
        }

        // 앱 초기화
        let app;
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = new LanguageLearningApp();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('App initialization error:', error);
                document.getElementById('status').textContent = '앱 초기화 중 오류가 발생했습니다.';
            }
        });

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', () => {
            if (app) {
                app.cleanup();
            }
        });

        // iOS Safari 추가 최적화
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) { 
                e.preventDefault(); 
            }
        }, { passive: false });

        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // 화면 회전 시 레이아웃 조정
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });

        // Service Worker 등록 (PWA 지원)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed (normal in preview): ', registrationError);
                    });
            });
        }

        // Web App Manifest 체크
        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running as PWA');
            document.body.style.paddingTop = '40px';
        }

        // 메모리 관리를 위한 주기적 정리
        if (typeof setInterval !== 'undefined') {
            setInterval(() => {
                if (performance && performance.memory && performance.memory.usedJSHeapSize > 50000000) { // 50MB
                    console.log('Memory cleanup triggered');
                    if (window.gc) {
                        window.gc();
                    }
                }
            }, 60000); // 1분마다 체크
        }
    </script>
</body>
</html>